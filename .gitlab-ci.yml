image: node:20.18.0  # lts/iron = 20.18.0

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

stages:
  - unit
  - e2e
  - deploy

# -----------------------------
# Cache global melhorado
# -----------------------------
cache: &global-cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# -----------------------------
# UNIT TESTS
# -----------------------------
Execute Unit Tests:
  stage: unit
  cache:
    <<: *global-cache
  environment:
    name: production
  before_script:
    - npm ci --prefer-offline --no-audit --no-fund
    - npx prisma generate
  script:
    - npm run test:cov
  artifacts:
    expire_in: 2h
    paths:
      - coverage/
  only:
    refs:
      - main

# -----------------------------
# E2E TESTS (com Docker)
# -----------------------------
Execute EndtoEnd Tests:
  stage: e2e
  image: docker:29.1.3  # VersÃ£o fixa do Docker
  services:
    - docker:29.1.3-dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  cache:
    <<: *global-cache
    policy: pull
  before_script:
    - apk add --no-cache nodejs npm
    - npm ci --prefer-offline --no-audit --no-fund
    - npx prisma generate
    - docker pull mysql:8.0
  script:
    - npm run test:e2e
  needs:
    - job: Execute Unit Tests
      artifacts: false
  only:
    refs:
      - main

# -----------------------------
# DEPLOY
# -----------------------------
Release & Publish Image:
  stage: deploy
  image: docker:29.1.3
  services:
    - docker:29.1.3-dind
  environment:
    name: production
  cache:
    <<: *global-cache
    policy: pull
  before_script:
    - apk add --no-cache nodejs npm git
    - npm ci --prefer-offline --no-audit --no-fund
    - chmod +x ./ci_cd/build.sh
  script:
    - npm run release
  needs:
    - job: Execute EndtoEnd Tests
      artifacts: false
  only:
    refs:
      - main