image: node:24.13.1-alpine
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

workflow:
  auto_cancel:
    on_new_commit: interruptible
    on_job_failure: none
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

default:
  interruptible: true

stages:
  - security
  - unit
  - e2e
  - deploy

cache: &global-cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull

# -----------------------------
# PRE
# -----------------------------
Install Dependencies:
  stage: .pre
  cache:
    <<: *global-cache
    policy: pull-push  # Ãºnico job que escreve no cache
  script:
    - npm ci --no-audit --no-fund

# -----------------------------
# SECURITY
# -----------------------------
Security Audit:
  stage: security
  cache:
    <<: *global-cache
    policy: pull
  before_script:
    - npm ci --no-audit --no-fund
  script:
    - npm audit --production --json > npm-audit.json || true
    - echo "=== RESUMO DE VULNERABILIDADES ==="
    - npm audit --production --audit-level=high
  artifacts:
    expire_in: 90d
    paths:
      - npm-audit.json
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------
# UNIT TESTS
# -----------------------------
Execute Unit Tests:
  stage: unit
  cache:
    <<: *global-cache
    policy: pull
  environment:
    name: production
  before_script:
    - npm ci --prefer-offline --no-audit --no-fund
    - npx prisma generate
  script:
    - npm run test:cov
  artifacts:
    expire_in: 2h
    paths:
      - coverage/
  needs:
    - job: Security Audit
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------
# E2E TESTS
# -----------------------------
Execute EndtoEnd Tests:
  stage: e2e
  image: docker:29.1.3
  services:
    - docker:29.1.3-dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  cache:
    <<: *global-cache
    policy: pull
  before_script:
    - apk add --no-cache nodejs npm
    - npm ci --prefer-offline --no-audit --no-fund
    - npx prisma generate
    - docker pull mysql:8.0
  script:
    - npm run test:e2e
  needs:
    - job: Execute Unit Tests
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------
# DEPLOY
# -----------------------------
Release & Publish Image:
  stage: deploy
  image: docker:29.1.3
  services:
    - docker:29.1.3-dind
  environment:
    name: production
  cache:
    <<: *global-cache
    policy: pull
  before_script:
    - apk add --no-cache nodejs npm git
    - npm ci --prefer-offline --no-audit --no-fund
    - chmod +x ./ci_cd/build.sh
  script:
    - npm run release
  needs:
    - job: Execute EndtoEnd Tests
  rules:
    - if: $CI_COMMIT_BRANCH == "main"