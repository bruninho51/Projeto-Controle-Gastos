image: node:20

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - unit
  - e2e
  - deploy

# -----------------------------
# Cache global
# -----------------------------
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# -----------------------------
# UNIT TESTS
# -----------------------------
Execute Unit Tests:
  stage: unit
  environment:
    name: production
  before_script:
    - npm ci
    - npx prisma generate
  script:
    - npm run test:cov
  artifacts:
    expire_in: 2h
    paths:
      - coverage/
  only:
    refs:
      - main

# -----------------------------
# E2E TESTS (com Docker)
# -----------------------------
Execute EndtoEnd Tests:
  stage: e2e
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache nodejs npm
    - npm ci
    - npx prisma generate
    - docker pull mysql:8.0
  script:
    - npm run test:e2e
  needs:
    - job: Execute Unit Tests
      artifacts: false
  only:
    refs:
      - main

# -----------------------------
# DEPLOY
# -----------------------------
Release & Publish Image:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  environment:
    name: production
  before_script:
    - apk add --no-cache nodejs npm git
    - npm ci
    - chmod +x ./ci_cd/build.sh
  script:
    # semantic-release executa o build.sh automaticamente
    - npm run release
  needs:
    - job: Execute EndtoEnd Tests
      artifacts: false
  only:
    refs:
      - main