image: node:latest

variables:
  GIT_DEPTH: 0
  GL_TOKEN: $GITLAB_TOKEN

stages:
  - deploy

deploy:
  stage: deploy
  environment: production
  before_script:
    - apt-get update && apt-get install -y curl
  script:
    # Info bÃ¡sica
    - echo "Node version:"
    - node -v
    - echo ""

    # ðŸ”Ž TESTE 1 â€” CI_JOB_TOKEN
    - echo "=============================="
    - echo "ðŸ”Ž Testando CI_JOB_TOKEN"
    - echo "=============================="
    - |
      curl -s -o response_ci.json -w "HTTP_STATUS:%{http_code}\n" \
      --header "JOB-TOKEN: $CI_JOB_TOKEN" \
      https://gitlab.com/api/v4/projects/bruninho51%2Fprojeto-controle-gastos
    - cat response_ci.json
    - echo ""

    # ðŸ”Ž TESTE 2 â€” GITLAB_TOKEN
    - echo "=============================="
    - echo "ðŸ”Ž Testando GITLAB_TOKEN"
    - echo "=============================="
    - |
      curl -s -o response_gl.json -w "HTTP_STATUS:%{http_code}\n" \
      --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
      https://gitlab.com/api/v4/projects/bruninho51%2Fprojeto-controle-gastos
    - cat response_gl.json
    - echo ""

    # Build normal
    - npm ci
    - chmod +x ./ci_cd/build.sh

    - git remote set-url origin https://oauth2:${GITLAB_TOKEN}@gitlab.com/bruninho51/projeto-controle-gastos.git

    # Release com verbose
    - DEBUG=semantic-release:*,@semantic-release/* npm run release

  only:
    - main