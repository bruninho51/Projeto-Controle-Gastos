image: node:24.13.1-bookworm

variables:
  GIT_DEPTH: 0
  GL_TOKEN: $GITLAB_TOKEN

stages:
  - deploy

deploy:
  stage: deploy
  environment: production
  before_script:
    - apt-get update && apt-get install -y curl
  script:
    - echo "Node version:"
    - node -v
    - echo ""

    # ðŸ”Ž TESTE 1 â€” CI_JOB_TOKEN
    - echo "=============================="
    - echo "ðŸ”Ž Testando CI_JOB_TOKEN"
    - echo "=============================="
    - |
      curl -s -o response_ci.json -w "HTTP_STATUS:%{http_code}\n" \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        https://gitlab.com/api/v4/projects/bruninho51%2Fprojeto-controle-gastos
    - cat response_ci.json
    - echo ""

    # ðŸ”Ž TESTE 2 â€” GITLAB_TOKEN
    - echo "=============================="
    - echo "ðŸ”Ž Testando GITLAB_TOKEN"
    - echo "=============================="
    - |
      curl -s -o response_gl.json -w "HTTP_STATUS:%{http_code}\n" \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        https://gitlab.com/api/v4/projects/bruninho51%2Fprojeto-controle-gastos
    - cat response_gl.json
    - echo ""

    # ðŸ”Ž TESTE 3 â€” GL_TOKEN via path encoded
    - echo "=============================="
    - echo "ðŸ”Ž Testando GL_TOKEN via path encoded"
    - echo "=============================="
    - |
      curl -s -o response_gl_path.json -w "HTTP_STATUS:%{http_code}\n" \
        --header "PRIVATE-TOKEN: $GL_TOKEN" \
        "https://gitlab.com/api/v4/projects/bruninho51%2Fprojeto-controle-gastos"
    - cat response_gl_path.json
    - echo ""

    # ðŸ”Ž TESTE 4 â€” releases endpoint
    - echo "=============================="
    - echo "ðŸ”Ž Testando endpoint de releases"
    - echo "=============================="
    - |
      curl -s -o response_releases.json -w "HTTP_STATUS:%{http_code}\n" \
        --header "PRIVATE-TOKEN: $GL_TOKEN" \
        "https://gitlab.com/api/v4/projects/65827697/releases"
    - cat response_releases.json
    - echo ""

    # ðŸ”Ž TESTE 5 â€” usuÃ¡rio do token
    - echo "=============================="
    - echo "ðŸ”Ž UsuÃ¡rio do GL_TOKEN"
    - echo "=============================="
    - |
      curl -s -o response_user.json -w "HTTP_STATUS:%{http_code}\n" \
        --header "PRIVATE-TOKEN: $GL_TOKEN" \
        "https://gitlab.com/api/v4/user"
    - cat response_user.json
    - echo ""

    # Build
    - npm ci
    - chmod +x ./ci_cd/build.sh
    - git remote set-url origin https://oauth2:${GITLAB_TOKEN}@gitlab.com/bruninho51/projeto-controle-gastos.git

    # ðŸ”§ Patch do bug no @semantic-release/gitlab v13
    - |
      sed -i \
        's/headers: { tokenHeader: gitlabToken }/headers: { [tokenHeader]: gitlabToken }/g' \
        node_modules/@semantic-release/gitlab/lib/verify.js
    - echo "âœ… Patch aplicado:"
    - grep "tokenHeader" node_modules/@semantic-release/gitlab/lib/verify.js

    - DEBUG=semantic-release:*,@semantic-release/* npm run release

  only:
    - main